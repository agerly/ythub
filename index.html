<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YT HUB PRO - v5.7 AutoFocus Fix</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <script>
    tailwind.config = { 
        darkMode: 'class',
        theme: {
            extend: {
                boxShadow: {
                    'tv-glow': '0 0 0 4px #DC2626, 0 0 30px rgba(220, 38, 38, 0.8)',
                }
            }
        }
    }
  </script>

  <style>
    .ghost { opacity: 0.3; background: #cbd5e1; }
    .drag-handle { cursor: grab; }
    
    .category-header { cursor: pointer; } 
    
    .is-locked .category-header { cursor: pointer !important; }
    .is-locked .drag-handle { display: none !important; }

    #mainBoard { 
      display: block; 
      column-gap: 1.5rem;
      width: 100%;
      padding-bottom: 50px;
    }
    @media (min-width: 768px) { #mainBoard { column-count: 2; } }
    @media (min-width: 1280px) { #mainBoard { column-count: 3; } }
    @media (min-width: 1600px) { #mainBoard { column-count: 4; } }

    .column-width { display: inline-block; width: 100%; margin-bottom: 1.5rem; break-inside: avoid; }
    .sortable-list { min-height: 10px; height: auto; overflow: visible; transition: all 0.3s ease; }
    
    .list-hidden { display: none !important; }

    .is-new-border { border-left: 5px solid #dc2626 !important; }
    body { transition: background-color 0.3s ease; }
    
    .dark ::-webkit-scrollbar { width: 8px; }
    .dark ::-webkit-scrollbar-track { background: #1e293b; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }

    /* --- STILE FOCUS TV --- */
    .tv-card:focus { outline: none; }
    
    .video-card:focus {
        box-shadow: 0 0 0 5px #ff0000, 0 0 25px rgba(255, 0, 0, 0.6); 
        transform: scale(1.03); 
        z-index: 50;
        background-color: #252525;
        border-color: #ff0000;
    }
    html:not(.dark) .video-card:focus { background-color: #fff; }

    .header-card:focus {
        box-shadow: 0 0 0 4px #fbbf24, 0 0 20px rgba(251, 191, 36, 0.6);
        z-index: 51;
        position: relative;
        transform: scale(1.02);
    }

  </style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 min-h-screen">
  <div class="p-4 sm:p-8">
    <header class="max-w-[1600px] mx-auto mb-6 flex flex-col gap-4 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div>
          <h1 class="text-2xl font-black text-slate-800 dark:text-white tracking-tighter italic flex items-baseline gap-2">
            <span>YT HUB <span class="text-red-600 font-normal">TV</span></span>
            <span class="text-xs text-slate-400 font-mono font-normal">v5.7</span>
          </h1>
          <p id="statusLine" class="text-slate-400 text-xs mt-2 font-bold uppercase tracking-widest"></p>
        </div>

        <div class="relative w-full lg:max-w-md">
            <input type="text" id="searchInput" oninput="fn_handleSearch()" placeholder="Cerca..." 
                class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-700 dark:text-white border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-red-500">
        </div>

        <div class="flex flex-wrap gap-2 items-center">
          <button onclick="fn_toggleDarkMode()" class="p-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-amber-400"><i id="darkIcon" class="fas fa-moon"></i></button>
          <button onclick="fn_toggleCompact()" id="compactBtn" class="p-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-bold"><i class="fas fa-compress-alt"></i></button>
          <button id="lockBtn" onclick="fn_toggleLock()" class="bg-sky-500 text-white px-3 py-2 rounded-xl font-bold text-xs"><i id="lockIcon" class="fas fa-lock-open"></i></button>
          <button onclick="fn_addSingleChannel()" class="bg-red-600 text-white px-3 py-2 rounded-xl font-bold text-xs"><i class="fas fa-plus"></i></button>
          <button id="updateAllBtn" onclick="fn_checkAllUpdates()" class="bg-emerald-600 text-white px-3 py-2 rounded-xl font-bold text-xs"><i id="updateIcon" class="fas fa-rotate"></i></button>
          <button id="auth_button" onclick="handleAuthClick()" class="bg-amber-600 text-white px-3 py-2 rounded-xl font-bold text-xs"><i class="fab fa-google"></i> DRIVE</button>
          <button onclick="fn_saveSettings()" class="bg-slate-800 dark:bg-slate-600 text-white px-3 py-2 rounded-xl font-bold text-xs">SALVA</button>
        </div>
      </div>
    </header>

    <div class="max-w-[1600px] mx-auto mb-8 bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-wrap gap-4 justify-between items-center">
        <button onclick="fn_addCategory()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold text-xs shadow-sm">+ CATEGORIA</button>
        <div class="flex gap-4 items-center">
            <label class="flex items-center gap-2 text-sm font-bold text-slate-600 dark:text-slate-400"><input id="useProxyToggle" type="checkbox" class="accent-emerald-600 w-4 h-4" /> Proxy</label>
            <input id="proxyUrlInput" type="text" class="px-3 py-1 rounded border dark:bg-slate-700 dark:text-white text-xs w-48" placeholder="Proxy URL..." />
        </div>
    </div>

    <div id="mainBoard" class="max-w-[1600px] mx-auto"></div>
  </div>

  <script>
    // --- COSTANTI ---
    const CLIENT_ID = '530637025416-kbq28ucudmp4tdj7krlqjvmcamrv3dr9.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyCGDLbdjDyKSAO7XhGLjrLrYvywUG4PhX0';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const SYNC_FILE_NAME = "ythub_cloud_sync.json";
    const STORAGE_KEY = "yt_hub_vstable";
    const SETTINGS_KEY = "yt_hub_settings";
    const FOCUS_KEY = "yt_hub_last_focus_id";

    const DEFAULT_DATA = [
      { id: "top-channels", title: "★ TOP CHANNELS", color: "bg-amber-500", channels: [], isCollapsed: false },
      { id: "inbox", title: "DA SMISTARE", color: "bg-slate-700", channels: [], isCollapsed: false }
    ];

    let appData = loadData();
    let settings = loadSettings();
    let searchTerm = "";
    let tokenClient, gapiInited = false, gisInited = false, driveFileId = null;

    // --- CARICAMENTO / SALVATAGGIO ---
    function loadSettings() { try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || { useProxy: false, proxyUrlTemplate: "", isLocked: false, isDark: true, isCompact: false }; } catch { return { useProxy: false, proxyUrlTemplate: "", isLocked: false, isDark: true, isCompact: false }; } }
    function persistSettings() { localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }
    function loadData() {
      try { 
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(DEFAULT_DATA);
        const parsed = JSON.parse(raw);
        parsed.forEach(cat => { if (cat.isCollapsed === undefined) cat.isCollapsed = false; });
        if (!parsed.some(c => c.id === "top-channels")) parsed.unshift(structuredClone(DEFAULT_DATA[0]));
        return parsed;
      } catch { return structuredClone(DEFAULT_DATA); }
    }
    function persistData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); if (driveFileId && gapi.client.getToken()) { saveToDrive(); } }
    function setStatus(msg) { document.getElementById("statusLine").textContent = msg || ""; }

    // --- UI HELPERS ---
    function applyTheme() {
      const icon = document.getElementById("darkIcon");
      if (settings.isDark) { document.documentElement.classList.add('dark'); icon.className = "fas fa-sun"; } 
      else { document.documentElement.classList.remove('dark'); icon.className = "fas fa-moon"; }
    }
    function fn_toggleDarkMode() { settings.isDark = !settings.isDark; persistSettings(); applyTheme(); }
    function updateCompactUI() {
      const btn = document.getElementById("compactBtn");
      if(settings.isCompact) { btn.classList.replace("bg-slate-100", "bg-indigo-500"); btn.classList.add("text-white"); } 
      else { btn.classList.replace("bg-indigo-500", "bg-slate-100"); btn.classList.remove("text-white"); }
    }
    function fn_toggleCompact() { settings.isCompact = !settings.isCompact; persistSettings(); updateCompactUI(); render(); }
    function fn_handleSearch() { searchTerm = document.getElementById("searchInput").value.toLowerCase(); render(); }
    function fn_toggleLock() { settings.isLocked = !settings.isLocked; persistSettings(); updateLockUI(); render(); }
    function updateLockUI() {
      const btn = document.getElementById("lockBtn"), icon = document.getElementById("lockIcon");
      if (settings.isLocked) { 
        btn.classList.replace("bg-sky-500", "bg-slate-500"); icon.className = "fas fa-lock"; document.body.classList.add('is-locked');
      } else { 
        btn.classList.replace("bg-slate-500", "bg-sky-500"); icon.className = "fas fa-lock-open"; document.body.classList.remove('is-locked');
      }
    }

    // --- LOGICA BUSTE (COLLAPSE & MARK ALL) ---
    function fn_toggleCollapse(catId) {
        const cat = appData.find(c => c.id === catId);
        if (cat) {
            cat.isCollapsed = !cat.isCollapsed;
            persistData();
            render();
            // Refocus header
            setTimeout(() => {
                const header = document.querySelector(`[data-header-id="${catId}"]`);
                if(header) header.focus();
            }, 50);
        }
    }

    window.fn_markCategorySeen = function(catId) {
        const cat = appData.find(c => c.id === catId);
        if (!cat) return;
        let changed = false;
        cat.channels.forEach(ch => {
            if (ch.isNew) {
                ch.isNew = false;
                ch.lastSeenVideoId = ch.latestVideoId;
                changed = true;
            }
        });
        if (changed) {
            persistData();
            render();
        }
    };

    // --- NOTEBOOKLM LOGIC ---
    window.fn_notebookLM = function(url) {
        // 1. Copia URL
        navigator.clipboard.writeText(url).then(() => {
            setStatus("Link copiato! Aprendo NotebookLM...");
            // 2. Apre NotebookLM in nuova scheda
            window.open("https://notebooklm.google.com/", "_blank");
            setTimeout(() => setStatus(""), 3000);
        }).catch(err => {
            console.error(err);
            // Fallback
            window.open("https://notebooklm.google.com/", "_blank");
        });
    }

    // --- RENDER ---
    function render(isUpdating = false) {
      const board = document.getElementById("mainBoard");
      const scrollPos = isUpdating ? window.scrollY : null;
      board.innerHTML = "";
      
      const topChannels = appData.find(c => c.id === "top-channels").channels.map(c => c.id);

      appData.forEach(cat => {
        const filteredChannels = cat.channels.filter(ch => 
            ch.name.toLowerCase().includes(searchTerm) || (ch.latestVideoTitle && ch.latestVideoTitle.toLowerCase().includes(searchTerm))
        );

        if (searchTerm !== "" && filteredChannels.length === 0) return;

        const newCount = filteredChannels.filter(ch => ch.isNew).length;
        const isCollapsed = cat.isCollapsed === true;

        const col = document.createElement("div");
        col.className = "column-width";
        col.dataset.colCatId = cat.id;

        // --- HEADER (BUSTA) ---
        const header = document.createElement("div");
        header.className = `tv-card header-card ${cat.color} text-white p-4 rounded-t-2xl font-bold flex justify-between items-center shadow-sm category-header select-none transition-transform`;
        header.setAttribute("tabindex", "0");
        header.dataset.headerId = cat.id;
        header.title = "Clicca o premi Enter per Aprire/Chiudere";
        
        const iconClass = isCollapsed ? 'fa-envelope' : 'fa-envelope-open';
        
        let actionsHtml = "";
        
        if (newCount > 0) {
            actionsHtml += `
                <button class="opacity-70 hover:opacity-100 hover:text-emerald-300 mr-3 focus:text-emerald-300 transition-colors" 
                        title="Segna tutti come letti" 
                        onclick="event.stopPropagation(); fn_markCategorySeen('${cat.id}')">
                    <i class="fas fa-circle-check text-lg"></i>
                </button>
            `;
        }

        if (cat.id !== "inbox" && cat.id !== "top-channels") {
             actionsHtml += `<button class="opacity-50 hover:opacity-100 ml-2 focus:text-black" onclick="event.stopPropagation(); fn_deleteCategory('${cat.id}')"><i class="fas fa-times"></i></button>`;
        }

        let badgeHtml = "";
        if (isCollapsed && newCount > 0) {
            badgeHtml = `<span class="bg-red-600 text-white text-[10px] px-2 py-0.5 rounded-full shadow-md ml-2 border border-white animate-pulse">${newCount}</span>`;
        }

        header.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="fas ${iconClass} opacity-80"></i>
                <span class="tracking-tight uppercase text-xs flex items-center">
                    ${cat.title} 
                    <span class="opacity-70 ml-1 font-normal">(${filteredChannels.length})</span>
                    ${badgeHtml}
                </span>
            </div>
            <div class="flex items-center">${actionsHtml}</div>
        `;
        
        header.onclick = () => fn_toggleCollapse(cat.id);
        header.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                fn_toggleCollapse(cat.id);
            }
        });

        // --- LISTA CANALI ---
        const list = document.createElement("div");
        list.id = cat.id;
        list.className = `sortable-list bg-white dark:bg-slate-800 p-3 rounded-b-2xl shadow-sm border border-slate-200 dark:border-slate-700 grid grid-cols-1 gap-3 ${isCollapsed ? 'list-hidden' : ''}`;

        if (!isCollapsed) {
            filteredChannels.forEach(ch => {
              const item = document.createElement("div");
              const isActuallyNew = ch.isNew === true;
              const isFavorite = topChannels.includes(ch.id);
              const paddingClass = settings.isCompact ? 'p-3' : 'p-4';
              const titleSize = settings.isCompact ? 'text-xs' : 'text-sm';
              const videoWatchUrl = ch.latestVideoId ? `https://www.youtube.com/watch?v=${ch.latestVideoId}` : ch.url;
              const dateLabel = ch.latestVideoPublished ? new Date(ch.latestVideoPublished).toLocaleDateString("it-IT", {day:'2-digit', month:'2-digit'}) : "--/--";
              const durationLabel = ch.latestVideoDuration ? `<span class="opacity-60 ml-1">• ${ch.latestVideoDuration}</span>` : "";

              item.setAttribute("tabindex", "0"); 
              item.dataset.chId = ch.id;
              item.dataset.videoUrl = videoWatchUrl;
              item.dataset.parentCatId = cat.id;
              item.className = `
                tv-card video-card
                relative flex flex-col justify-between 
                bg-white dark:bg-slate-800 
                border border-slate-100 dark:border-slate-700
                rounded-xl shadow-sm transition-all duration-200
                cursor-pointer
                ${isActuallyNew ? 'is-new-border' : ''}
                ${paddingClass}
              `;

              item.innerHTML = `
                <div class="mb-2 flex justify-between items-start">
                    <div class="truncate ${titleSize} font-bold text-slate-800 dark:text-slate-100" title="${ch.name}">${ch.name}</div>
                    ${!settings.isLocked ? '<i class="fas fa-grip-vertical text-slate-300 dark:text-slate-600 drag-handle"></i>' : ''}
                </div>
                
                <div class="flex-1 mb-3">
                    <div class="block leading-snug text-xs uppercase tracking-tight ${isActuallyNew ? 'text-red-600 font-black' : 'text-slate-500 dark:text-slate-400 font-medium'} line-clamp-2">
                      ${ch.latestVideoTitle || 'Nessun video recente'}
                    </div>
                </div>

                <div class="flex items-end justify-between mt-auto pt-2 border-t border-slate-100 dark:border-slate-700">
                    <div class="text-[9px] text-slate-400 font-bold uppercase flex items-center">
                      ${dateLabel} ${durationLabel}
                    </div>
                    <div class="flex gap-2 items-center">
                      <i class="fas fa-book text-xs text-slate-300 dark:text-slate-600 hover:text-purple-500" title="Copia link e apri NotebookLM" onclick="event.stopPropagation(); fn_notebookLM('${videoWatchUrl}')"></i>
                      <i class="${isFavorite ? 'fas text-rose-500' : 'far text-slate-300 dark:text-slate-600'} fa-heart text-xs" onclick="event.stopPropagation(); fn_toggleFavorite('${ch.id}')"></i>
                      <i class="fas fa-check-circle text-xs text-slate-300 dark:text-slate-600 hover:text-emerald-500" onclick="event.stopPropagation(); fn_markSeen('${ch.id}')"></i>
                      <i class="fas fa-trash text-xs text-slate-300 dark:text-slate-600 hover:text-red-500" onclick="event.stopPropagation(); fn_deleteChannel('${ch.id}', '${cat.id}')"></i>
                    </div>
                </div>
              `;
              
              item.addEventListener('focus', () => { localStorage.setItem(FOCUS_KEY, ch.id); });
              item.addEventListener('click', () => { window.open(videoWatchUrl, '_blank'); fn_markSeen(ch.id); });
              
              item.addEventListener('keydown', (e) => {
                  if (e.key === 'Enter') {
                      e.preventDefault();
                      window.open(videoWatchUrl, '_blank');
                      fn_markSeen(ch.id);
                  }
                  if (e.key === 'Delete') {
                      e.preventDefault();
                      // --- FIX: CALCOLA IL PROSSIMO ELEMENTO PRIMA DEL RENDER ---
                      const nextItem = item.nextElementSibling;
                      if (nextItem && nextItem.dataset.chId) {
                           localStorage.setItem(FOCUS_KEY, nextItem.dataset.chId);
                      }
                      fn_markSeen(ch.id);
                  }
              });

              list.appendChild(item);
            });
        }

        col.appendChild(header);
        col.appendChild(list);
        board.appendChild(col);
        
        if (!settings.isLocked) {
             new Sortable(list, {
              group: "channels", animation: 150, ghostClass: "ghost", handle: ".drag-handle", disabled: isCollapsed,
              onAdd: function (evt) { syncFromDOM(); persistData(); render(); },
              onEnd: () => { syncFromDOM(); persistData(); render(); }
            });
        }
      });
      
      new Sortable(board, { animation: 150, ghostClass: "ghost", handle: ".category-header", disabled: settings.isLocked, onEnd: () => { syncFromDOM(); persistData(); render(); } });
      
      if(isUpdating && scrollPos) window.scrollTo(0, scrollPos);
      if(!isUpdating) {
        setStatus(`Monitorando ${countChannels()} canali. TV Mode On.`);
        restoreFocus();
      }
    }

    function restoreFocus() {
        const lastId = localStorage.getItem(FOCUS_KEY);
        if (lastId) {
            setTimeout(() => {
                const el = document.querySelector(`[data-ch-id="${lastId}"]`);
                if (el && el.offsetParent !== null) { 
                    el.focus();
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
    }

    // --- LOGICA SCACCHIERA (CHESSBOARD NAV) ---
    document.addEventListener('keydown', (e) => {
        const navKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
        if (!navKeys.includes(e.key)) return;
        e.preventDefault(); 
        
        const current = document.activeElement.closest('.tv-card');
        if (!current) return;

        let currentCategoryDiv = current.closest('.column-width');
        if (!currentCategoryDiv) return;

        // --- FRECCIA DESTRA / SINISTRA ---
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
            const curRect = currentCategoryDiv.getBoundingClientRect();
            let bestTargetHeader = null;
            let minDistance = Infinity;

            const allHeaders = Array.from(document.querySelectorAll('.header-card'));
            
            allHeaders.forEach(header => {
                const hRect = header.getBoundingClientRect();
                if (header.closest('.column-width') === currentCategoryDiv) return;

                let isValid = false;
                if (e.key === 'ArrowRight') {
                    if (hRect.left > curRect.right - 50) isValid = true; 
                } else {
                    if (hRect.right < curRect.left + 50) isValid = true;
                }

                if (isValid) {
                    const distX = Math.abs(hRect.left - curRect.left);
                    const distY = Math.abs(hRect.top - curRect.top);
                    const dist = distX + (distY * 0.5); 
                    
                    if (dist < minDistance) {
                        minDistance = dist;
                        bestTargetHeader = header;
                    }
                }
            });

            if (bestTargetHeader) {
                bestTargetHeader.focus();
                bestTargetHeader.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        // --- FRECCIA SU / GIU ---
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            const allCards = Array.from(document.querySelectorAll('.tv-card'));
            const visibleCards = allCards.filter(el => el.offsetParent !== null);
            
            const curRect = current.getBoundingClientRect();
            const curCenterX = curRect.left + curRect.width / 2;
            
            let bestCandidate = null;
            let minV_Dist = Infinity;

            visibleCards.forEach(card => {
                if (card === current) return;
                const cRect = card.getBoundingClientRect();
                const cCenterX = cRect.left + cRect.width / 2;

                if (Math.abs(cCenterX - curCenterX) > curRect.width * 0.5) return; 

                const yDiff = cRect.top - curRect.top;
                
                let isValid = false;
                if (e.key === 'ArrowDown' && yDiff > 0) isValid = true;
                if (e.key === 'ArrowUp' && yDiff < 0) isValid = true;

                if (isValid) {
                    const dist = Math.abs(yDiff);
                    if (dist < minV_Dist) {
                        minV_Dist = dist;
                        bestCandidate = card;
                    }
                }
            });

            if (bestCandidate) {
                bestCandidate.focus();
                bestCandidate.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
    });

    window.fn_checkAllUpdates = async function() {
        const all = appData.flatMap(cat => cat.channels);
        const unique = Array.from(new Set(all.map(ch => ch.id))).map(id => all.find(ch => ch.id === id));
        let processed = 0, total = unique.length;
        const btn = document.getElementById("updateAllBtn"), icon = document.getElementById("updateIcon");
        btn.disabled = true; icon.classList.add("fa-spin");
        
        for (let i = 0; i < unique.length; i += 10) {
            const chunk = unique.slice(i, i + 10);
            await Promise.all(chunk.map(async (ch) => {
                try {
                    const url = settings.useProxy ? settings.proxyUrlTemplate.replace("{ID}", ch.id) : `https://www.youtube.com/feeds/videos.xml?channel_id=${ch.id}`;
                    const resp = await fetch(url);
                    const data = await resp.json();
                    if(data && data.videoId) {
                        appData.forEach(cat => {
                            const idx = cat.channels.findIndex(c => c.id === ch.id);
                            if (idx > -1) {
                                const inst = cat.channels[idx];
                                if (inst.lastSeenVideoId !== data.videoId) {
                                    Object.assign(inst, { 
                                        isNew: true, 
                                        latestVideoId: data.videoId, 
                                        latestVideoTitle: data.title, 
                                        latestVideoPublished: data.published, 
                                        latestVideoDuration: data.duration || null 
                                    });
                                    if (idx > 0) {
                                        cat.channels.splice(idx, 1);
                                        cat.channels.unshift(inst);
                                    }
                                }
                            }
                        });
                    }
                } catch (err) {}
                processed++; setStatus(`Verifica: ${processed} / ${total}...`);
            }));
            render(true); 
        }
        btn.disabled = false; icon.classList.remove("fa-spin"); persistData(); render(false);
    };

    window.fn_toggleFavorite = function(chId) {
        const topCat = appData.find(c => c.id === "top-channels");
        const alreadyFav = topCat.channels.findIndex(ch => ch.id === chId);
        if (alreadyFav > -1) { topCat.channels.splice(alreadyFav, 1); } 
        else {
            let sourceChannel = null;
            for (const cat of appData) { const found = cat.channels.find(c => c.id === chId); if (found) { sourceChannel = structuredClone(found); break; } }
            if (sourceChannel) topCat.channels.unshift(sourceChannel);
        }
        persistData(); render();
    };

    window.fn_markSeen = function(id) { appData.forEach(cat => cat.channels.forEach(ch => { if (ch.id === id) { ch.isNew = false; ch.lastSeenVideoId = ch.latestVideoId; } })); persistData(); render(); };
    window.fn_addSingleChannel = function() { const name = prompt("Nome Canale:"); const rawUrl = prompt("URL o Username:"); if (!name || !rawUrl) return; let id = rawUrl.includes('channel/') ? rawUrl.split('channel/')[1].split('/')[0] : rawUrl.replace('@', '').split('/').pop(); let url = rawUrl.startsWith('http') ? rawUrl : `https://www.youtube.com/@${id}`; appData.find(c => c.id === "inbox").channels.unshift({ id, name, url, isNew: true, latestVideoId: null, latestVideoTitle: null, latestVideoPublished: null, latestVideoDuration: null, lastSeenVideoId: null }); persistData(); render(); };
    window.fn_deleteChannel = function(chId, catId) { if (confirm("Rimuovere il canale?")) { const cat = appData.find(c => c.id === catId); cat.channels = cat.channels.filter(ch => ch.id !== chId); persistData(); render(); } };
    window.fn_addCategory = function() { const n = prompt("Nome:"); if (n) { appData.push({ id: "c_" + Date.now(), title: n.toUpperCase(), color: "bg-indigo-600", channels: [], isCollapsed: false }); persistData(); render(); } };
    function fn_deleteCategory(id) { if (confirm("Eliminare categoria?")) { const i = appData.findIndex(c => c.id === id); const inbox = appData.find(c => c.id === "inbox"); appData[i].channels.forEach(ch => { if(!inbox.channels.some(x => x.id === ch.id)) inbox.channels.push(ch); }); appData.splice(i, 1); persistData(); render(); } }
    
    function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] }); gapiInited = true; checkAuthPersistence(); }); }
    function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: async () => { localStorage.setItem("drive_connected", "true"); await initializeDriveFile(); } }); gisInited = true; checkAuthPersistence(); }
    function checkAuthPersistence() { if (gapiInited && gisInited && localStorage.getItem("drive_connected") === "true") tokenClient.requestAccessToken({ prompt: '' }); }
    async function handleAuthClick() { tokenClient.requestAccessToken({ prompt: 'consent' }); }
    async function initializeDriveFile() { try { const response = await gapi.client.drive.files.list({ q: `name = '${SYNC_FILE_NAME}' and trashed = false` }); if (response.result.files.length > 0) { driveFileId = response.result.files[0].id; await loadFromDrive(); } else { await createDriveFile(); } } catch { } }
    async function createDriveFile() { const response = await gapi.client.drive.files.create({ resource: { name: SYNC_FILE_NAME, mimeType: 'application/json' } }); driveFileId = response.result.id; saveToDrive(); }
    async function saveToDrive() { if (!driveFileId || !gapi.client.getToken()) return; await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`, { method: 'PATCH', headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token, 'Content-Type': 'application/json' }, body: JSON.stringify({ appData, settings }) }); }
    async function loadFromDrive() { const response = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' }); const cloudData = response.result || JSON.parse(response.body); if (cloudData.appData) { appData = cloudData.appData; settings = { ...settings, ...cloudData.settings }; persistSettings(); applyTheme(); updateCompactUI(); updateLockUI(); } localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); render(); }
    function countChannels() { const ids = new Set(); appData.forEach(c => { if(c.id !== "top-channels") c.channels.forEach(ch => ids.add(ch.id)) }); return ids.size; }
    window.fn_saveSettings = function() { settings.useProxy = document.getElementById("useProxyToggle").checked; settings.proxyUrlTemplate = document.getElementById("proxyUrlInput").value.trim(); persistSettings(); render(); if(driveFileId) saveToDrive(); };
    window.fn_reset = function() { if (confirm("Reset?")) { localStorage.clear(); location.reload(); } };
    
    function syncFromDOM() { 
        const newState = []; 
        const categoryDivs = document.querySelectorAll('.column-width');
        if(categoryDivs.length === 0) return;

        categoryDivs.forEach(col => {
            const listEl = col.querySelector('.sortable-list');
            if(!listEl) return;
            const catId = listEl.id;
            const originalCat = appData.find(c => c.id === catId);
            
            if(originalCat) {
                let newChannels = [];
                if (originalCat.isCollapsed) {
                    newChannels = originalCat.channels;
                } else {
                    listEl.querySelectorAll("[data-ch-id]").forEach(el => { 
                        const chId = el.dataset.chId; 
                        let found = null; 
                        for(const c of appData) { 
                            const m = c.channels.find(x => x.id === chId); 
                            if(m) { found = m; break; } 
                        } 
                        if(found) newChannels.push(structuredClone(found)); 
                    });
                }
                newState.push({ ...originalCat, channels: newChannels });
            }
        });
        
        appData.forEach(oldCat => {
            if(!newState.find(n => n.id === oldCat.id)) newState.push(oldCat);
        });

        appData = newState; 
    }

    window.onload = () => { document.getElementById("useProxyToggle").checked = settings.useProxy; document.getElementById("proxyUrlInput").value = settings.proxyUrlTemplate; applyTheme(); updateCompactUI(); updateLockUI(); render(); };
  </script>

  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>